;;; lsp.el --- Eglot High Performance Config -*- lexical-binding: t; -*-

;; --- 1. 基础性能与路径 ---
(setq gc-cons-threshold (* 100 1024 1024))
(setq read-process-output-max (* 3 1024 1024)) ;; 3MB 读取缓存 (Java 必须)

(defun my-force-inject-path ()
  "确保 Java 和常用工具在 PATH 中"
  (interactive)
  (let ((new-paths '("/opt/homebrew/bin"
                     "/usr/local/bin"
                     "/opt/homebrew/opt/openjdk@21/libexec/openjdk.jdk/Contents/Home/bin"))) ;; 强插 Java 21
    (dolist (path new-paths)
      (add-to-list 'exec-path path)
      (setenv "PATH" (concat path ":" (getenv "PATH"))))))
(my-force-inject-path)

(use-package exec-path-from-shell
  :ensure t
  :config
  (when (memq window-system '(mac ns x))
    (exec-path-from-shell-initialize)))

;; --- 2. 补全界面 (Corfu - 你喜欢的 Shift+空格版) ---
(use-package corfu
  :ensure t
  :custom
  (corfu-auto t)
  (corfu-auto-delay 0.1) ;; 稍微快一点，Eglot 反应很快
  (corfu-auto-prefix 2)
  (corfu-preview-current nil)
  (corfu-count 20)
  ;; 干脆利落的退出策略
  (corfu-quit-no-match 'separator) 
  (corfu-quit-at-boundary nil)
  (corfu-preview-current nil)
  (corfu-quit-no-match t)
  (corfu-quit-at-boundary t)
  (corfu-preselect 'prompt)
  :init
  (global-corfu-mode)
  :bind
  (:map corfu-map
        ("SPC" . nil);; 空格就是空格，不粘人
	("ESC" . nil)
        ("S-SPC" . corfu-insert-separator) ;; Shift+Space 才是过滤器
        ("RET" . corfu-insert)
        ("TAB" . corfu-next)
        ([tab] . corfu-next)
        ("S-TAB" . corfu-previous)
        ([backtab] . corfu-previous)))

;; 配合 Orderless 实现模糊搜索
(use-package orderless
  :ensure t
  :init
  (setq completion-styles '(orderless basic)
        completion-category-defaults nil
        completion-category-overrides '((file (styles partial-completion))))
(setq orderless-matching-styles '(orderless-literal orderless-regexp orderless-initialism)))
  

;; 图标支持
(use-package kind-icon
  :ensure t
  :after corfu
  :custom
  (kind-icon-default-style '(:padding 0 :stroke 0 :margin 0 :radius 0 :height 0.8 :scale 1.0))
  :config
  (add-to-list 'corfu-margin-formatters #'kind-icon-margin-formatter))

;; --- 3. Eglot (主角) ---
(use-package eglot
  :ensure t ;; 
  :hook 
  ((java-mode . eglot-ensure)
   (python-mode . eglot-ensure)
   (rust-ts-mode . eglot-ensure))
  :config
  (setenv "JAVA_TOOL_OPTIONS" 
          (concat "-javaagent:" (expand-file-name "~/.config/emacs/java/lombok.jar")))
  (setq eglot-java-server-install-dir (expand-file-name "~/.config/emacs/.cache/jdtls-eglot"))
  ;;(setq eglot-java-lombok-jar-path (expand-file-name "~/.config/emacs/java/lombok.jar"))
  
  (setq eglot-events-buffer-size 0)
  
  ;; 优化：关掉"高亮当前符号的所有引用" (这个功能在 Mac 上非常卡)
  (add-to-list 'eglot-ignored-server-capabilities :documentHighlightProvider)
  
  ;; 关键：设置 JAVA_HOME，确保 Eglot 启动正确的 Java
  (setenv "JAVA_HOME" "/opt/homebrew/opt/openjdk@21/libexec/openjdk.jdk/Contents/Home"))

;; --- 4. Eglot-Java (JDTLS 管理器) ---
;; 这个包会自动下载 JDTLS，类似 lsp-java，但更轻量
(use-package eglot-java
  :ensure t
  :hook (java-mode . eglot-java-mode)
  :config
  ;; 下载缓存路径
  (setq eglot-java-server-install-dir (expand-file-name "~/.emacs.d/.cache/jdtls-eglot"))
  ;; 纯净启动，不加载测试包
  (setq eglot-java-user-init-opts '(:bundles [])))

;; --- 5. Tree-sitter (语法高亮) ---
;; (use-package treesit
;;   :ensure nil
;;   :mode (("\\.java\\'" . java-ts-mode)
;;          ("\\.rs\\'" . rust-ts-mode)
;;          ("\\.json\\'" . json-ts-mode))
;;   :config
;;   (setq treesit-language-source-alist
;;         '((java "https://github.com/tree-sitter/tree-sitter-java")
;;           (json "https://github.com/tree-sitter/tree-sitter-json")
;;           (rust "https://github.com/tree-sitter/tree-sitter-rust"))))

(use-package treesit-auto
  :ensure t
  :custom
  ;; 设置默认不自动安装，而是询问用户 (如果你想全自动就设为 nil)
  (treesit-auto-install 'prompt)
  :config
  ;; 1. 把所有它支持的语言都加入到 Emacs 的下载列表中
  ;; 这样你就不用自己手写那个长长的 alist 了
  (treesit-auto-add-to-auto-mode-alist 'all)
  
  ;; 2. 开启全局模式
  ;; 它的作用是：当你打开文件时，自动尝试使用 ts-mode，并检查是否需要安装语法文件
  (global-treesit-auto-mode))


;; --- 6. Cape (辅助补全) ---
(use-package cape
  :ensure t
  :init
  (add-to-list 'completion-at-point-functions #'cape-file)
  (add-to-list 'completion-at-point-functions #'cape-dabbrev))

(provide 'lsp-eglot)
